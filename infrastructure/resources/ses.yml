Resources:
  # SES Configuration Set
  SESConfigurationSet:
    Type: AWS::SES::ConfigurationSet
    Properties:
      Name: ${self:service}-emails-${self:custom.stage}
      DeliveryOptions:
        TlsPolicy: Require
      ReputationTrackingEnabled: true
      SendingEnabled: true

  # Event destinations for SES metrics
  SESEventDestination:
    Type: AWS::SES::ConfigurationSetEventDestination
    Properties:
      ConfigurationSetName: !Ref SESConfigurationSet
      EventDestination:
        Name: ${self:service}-cloudwatch-events-${self:custom.stage}
        Enabled: true
        MatchingEventTypes:
          - send
          - reject
          - bounce
          - complaint
          - delivery
          - open
          - click
        CloudWatchDestination:
          DimensionConfigurations:
            - DimensionName: MessageTag
              DimensionValueSource: messageTag
              DefaultDimensionValue: default
            - DimensionName: EmailAddress
              DimensionValueSource: emailAddress
              DefaultDimensionValue: default

  # Email Templates
  AppointmentConfirmationTemplate:
    Type: AWS::SES::Template
    Properties:
      TemplateName: AppointmentConfirmation-${self:custom.stage}
      Subject: "âœ… Tu cita mÃ©dica RIMAC ha sido confirmada - {{appointmentId}}"
      TextPart: |
        Estimado/a {{patientName}},

        Â¡Tu cita mÃ©dica ha sido confirmada exitosamente!

        DETALLES DE TU CITA:
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        ğŸ“… Fecha y hora: {{appointmentDate}}
        ğŸ¥ Centro mÃ©dico: {{centerName}}
        ğŸ‘¨â€âš•ï¸ MÃ©dico: {{doctorName}}
        ğŸ©º Especialidad: {{specialty}}
        ğŸ“ DirecciÃ³n: {{centerAddress}}, {{centerCity}}
        
        ID de cita: {{appointmentId}}
        PaÃ­s: {{country}}

        INFORMACIÃ“N IMPORTANTE:
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        â€¢ Llega 15 minutos antes de tu cita
        â€¢ Trae tu documento de identidad
        â€¢ Trae tu carnÃ© de seguro RIMAC
        â€¢ Si necesitas cancelar, hazlo con 24h de anticipaciÃ³n

        Â¿Necesitas ayuda?
        ğŸ“ Central telefÃ³nica: {{phoneNumber}}
        ğŸ’¬ Chat online: {{chatUrl}}
        ğŸ“§ Email soporte: {{supportEmail}}

        Â¡Esperamos verte pronto!

        Equipo RIMAC
        Tu salud, nuestra prioridad

      HtmlPart: |
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="utf-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>ConfirmaciÃ³n de Cita - RIMAC</title>
          <style>
            body { font-family: 'Arial', sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; }
            .container { max-width: 600px; margin: 0 auto; background-color: #ffffff; }
            .header { background: linear-gradient(135deg, #0066cc, #004c99); color: white; padding: 20px; text-align: center; }
            .logo { font-size: 24px; font-weight: bold; margin-bottom: 10px; }
            .content { padding: 30px; }
            .appointment-card { background-color: #f8f9fa; border-left: 4px solid #0066cc; padding: 20px; margin: 20px 0; }
            .detail-row { display: flex; margin-bottom: 10px; }
            .detail-label { font-weight: bold; width: 140px; color: #333; }
            .detail-value { color: #555; flex: 1; }
            .important-info { background-color: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; margin: 20px 0; border-radius: 5px; }
            .footer { background-color: #f8f9fa; padding: 20px; text-align: center; color: #666; font-size: 14px; }
            .button { display: inline-block; background-color: #0066cc; color: white; padding: 12px 24px; text-decoration: none; border-radius: 5px; margin: 10px; }
            .contact-info { margin-top: 20px; }
            .contact-item { margin: 8px 0; }
          </style>
        </head>
        <body>
          <div class="container">
            <div class="header">
              <div class="logo">ğŸ¥ RIMAC</div>
              <h1>Â¡Cita Confirmada!</h1>
            </div>
            
            <div class="content">
              <h2>Estimado/a {{patientName}},</h2>
              <p>Â¡Tu cita mÃ©dica ha sido <strong>confirmada exitosamente</strong>!</p>
              
              <div class="appointment-card">
                <h3>ğŸ“‹ Detalles de tu cita</h3>
                <div class="detail-row">
                  <div class="detail-label">ğŸ“… Fecha y hora:</div>
                  <div class="detail-value"><strong>{{appointmentDate}}</strong></div>
                </div>
                <div class="detail-row">
                  <div class="detail-label">ğŸ¥ Centro mÃ©dico:</div>
                  <div class="detail-value">{{centerName}}</div>
                </div>
                <div class="detail-row">
                  <div class="detail-label">ğŸ‘¨â€âš•ï¸ MÃ©dico:</div>
                  <div class="detail-value">{{doctorName}}</div>
                </div>
                <div class="detail-row">
                  <div class="detail-label">ğŸ©º Especialidad:</div>
                  <div class="detail-value">{{specialty}}</div>
                </div>
                <div class="detail-row">
                  <div class="detail-label">ğŸ“ DirecciÃ³n:</div>
                  <div class="detail-value">{{centerAddress}}, {{centerCity}}</div>
                </div>
                <div class="detail-row">
                  <div class="detail-label">ğŸ†” ID de cita:</div>
                  <div class="detail-value"><code>{{appointmentId}}</code></div>
                </div>
              </div>

              <div class="important-info">
                <h3>ğŸ“ InformaciÃ³n importante</h3>
                <ul>
                  <li><strong>Llega 15 minutos antes</strong> de tu cita</li>
                  <li>Trae tu <strong>documento de identidad</strong></li>
                  <li>Trae tu <strong>carnÃ© de seguro RIMAC</strong></li>
                  <li>Para cancelar, hazlo con <strong>24h de anticipaciÃ³n</strong></li>
                </ul>
              </div>

              <div style="text-align: center; margin: 30px 0;">
                <a href="{{chatUrl}}" class="button">ğŸ’¬ Chat de Soporte</a>
                <a href="tel:{{phoneNumber}}" class="button">ğŸ“ Llamar</a>
              </div>

              <div class="contact-info">
                <h3>Â¿Necesitas ayuda?</h3>
                <div class="contact-item">ğŸ“ <strong>Central:</strong> {{phoneNumber}}</div>
                <div class="contact-item">ğŸ’¬ <strong>Chat:</strong> <a href="{{chatUrl}}">{{chatUrl}}</a></div>
                <div class="contact-item">ğŸ“§ <strong>Email:</strong> <a href="mailto:{{supportEmail}}">{{supportEmail}}</a></div>
              </div>
            </div>
            
            <div class="footer">
              <p><strong>Equipo RIMAC</strong><br>Tu salud, nuestra prioridad</p>
              <p>Este es un email automÃ¡tico, por favor no responder directamente.</p>
            </div>
          </div>
        </body>
        </html>

  AppointmentReminderTemplate:
    Type: AWS::SES::Template
    Properties:
      TemplateName: AppointmentReminder-${self:custom.stage}
      Subject: "ğŸ”” Recordatorio: Tu cita mÃ©dica es maÃ±ana - {{appointmentId}}"
      TextPart: |
        Estimado/a {{patientName}},

        Te recordamos que tienes una cita mÃ©dica programada para maÃ±ana:

        ğŸ“… Fecha: {{appointmentDate}}
        ğŸ¥ Centro: {{centerName}}
        ğŸ‘¨â€âš•ï¸ MÃ©dico: {{doctorName}}
        ğŸ“ {{centerAddress}}

        No olvides:
        â€¢ Llegar 15 minutos antes
        â€¢ Traer documento de identidad
        â€¢ Traer carnÃ© RIMAC

        ID: {{appointmentId}}

        Equipo RIMAC
      HtmlPart: |
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="utf-8">
          <title>Recordatorio de Cita - RIMAC</title>
        </head>
        <body style="font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f4;">
          <div style="max-width: 600px; margin: 0 auto; background-color: white; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <div style="background: linear-gradient(135deg, #ff6b35, #f7931e); color: white; padding: 20px; text-align: center;">
              <h1 style="margin: 0;">ğŸ”” Recordatorio de Cita</h1>
              <p style="margin: 10px 0 0 0;">RIMAC - Tu cita es maÃ±ana</p>
            </div>
            
            <div style="padding: 30px;">
              <h2>Hola {{patientName}},</h2>
              <p>Te recordamos que <strong>tienes una cita mÃ©dica programada para maÃ±ana</strong>:</p>
              
              <div style="background-color: #fff3cd; border-left: 4px solid #ff6b35; padding: 20px; margin: 20px 0;">
                <p><strong>ğŸ“… Fecha:</strong> {{appointmentDate}}</p>
                <p><strong>ğŸ¥ Centro:</strong> {{centerName}}</p>  
                <p><strong>ğŸ‘¨â€âš•ï¸ MÃ©dico:</strong> {{doctorName}}</p>
                <p><strong>ğŸ“ DirecciÃ³n:</strong> {{centerAddress}}</p>
                <p><strong>ğŸ†” ID:</strong> {{appointmentId}}</p>
              </div>

              <div style="background-color: #f8f9fa; padding: 15px; margin: 20px 0; border-radius: 5px;">
                <h3>ğŸ“ No olvides:</h3>
                <ul>
                  <li>Llegar <strong>15 minutos antes</strong></li>
                  <li>Traer <strong>documento de identidad</strong></li>
                  <li>Traer <strong>carnÃ© RIMAC</strong></li>
                </ul>
              </div>
            </div>
            
            <div style="background-color: #f8f9fa; padding: 20px; text-align: center; color: #666;">
              <p><strong>Equipo RIMAC</strong><br>Tu salud, nuestra prioridad</p>
            </div>
          </div>
        </body>
        </html>

  AppointmentCancellationTemplate:
    Type: AWS::SES::Template
    Properties:
      TemplateName: AppointmentCancellation-${self:custom.stage}
      Subject: "âŒ Tu cita mÃ©dica ha sido cancelada - {{appointmentId}}"
      TextPart: |
        Estimado/a {{patientName}},

        Tu cita mÃ©dica ha sido cancelada:

        ID de cita: {{appointmentId}}
        Fecha que estaba programada: {{appointmentDate}}
        Centro: {{centerName}}

        Motivo: {{cancellationReason}}

        Para reagendar, contacta:
        ğŸ“ {{phoneNumber}}
        ğŸ’¬ {{chatUrl}}

        Equipo RIMAC
      HtmlPart: |
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="utf-8">
          <title>Cita Cancelada - RIMAC</title>
        </head>
        <body style="font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f4;">
          <div style="max-width: 600px; margin: 0 auto; background-color: white; border-radius: 10px; overflow: hidden;">
            <div style="background-color: #dc3545; color: white; padding: 20px; text-align: center;">
              <h1 style="margin: 0;">âŒ Cita Cancelada</h1>
            </div>
            
            <div style="padding: 30px;">
              <h2>Hola {{patientName}},</h2>
              <p>Lamentamos informarte que tu cita mÃ©dica ha sido <strong>cancelada</strong>:</p>
              
              <div style="background-color: #f8d7da; border-left: 4px solid #dc3545; padding: 20px; margin: 20px 0;">
                <p><strong>ğŸ†” ID:</strong> {{appointmentId}}</p>
                <p><strong>ğŸ“… Fecha programada:</strong> {{appointmentDate}}</p>
                <p><strong>ğŸ¥ Centro:</strong> {{centerName}}</p>
                <p><strong>ğŸ“‹ Motivo:</strong> {{cancellationReason}}</p>
              </div>

              <div style="text-align: center; margin: 30px 0;">
                <a href="{{chatUrl}}" style="display: inline-block; background-color: #0066cc; color: white; padding: 12px 24px; text-decoration: none; border-radius: 5px; margin: 10px;">ğŸ’¬ Reagendar Cita</a>
              </div>
            </div>
          </div>
        </body>
        </html>

  # SQS Queue for email processing  
  EmailQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: ${self:service}-emails-${self:custom.stage}
      VisibilityTimeoutSeconds: 60
      MessageRetentionPeriod: 1209600  # 14 days
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt EmailDLQ.Arn
        maxReceiveCount: 3
      Tags:
        - Key: Environment
          Value: ${self:custom.stage}
        - Key: Service
          Value: ${self:service}
        - Key: Purpose
          Value: EmailProcessing

  EmailDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: ${self:service}-emails-dlq-${self:custom.stage}
      MessageRetentionPeriod: 1209600  # 14 days
      Tags:
        - Key: Environment
          Value: ${self:custom.stage}
        - Key: Service
          Value: ${self:service}
        - Key: Purpose
          Value: EmailDLQ

# Outputs for email resources
Outputs:
  SESConfigurationSetName:
    Description: "SES Configuration Set Name"
    Value: !Ref SESConfigurationSet
    Export:
      Name: ${self:service}-${self:custom.stage}-ses-config-set

  EmailQueueArn:
    Description: "Email Queue ARN"
    Value: !GetAtt EmailQueue.Arn
    Export:
      Name: ${self:service}-${self:custom.stage}-email-queue-arn

  EmailQueueUrl:
    Description: "Email Queue URL"
    Value: !Ref EmailQueue
    Export:
      Name: ${self:service}-${self:custom.stage}-email-queue-url

  AppointmentConfirmationTemplateArn:
    Description: "Appointment Confirmation Template ARN"
    Value: !Sub "arn:aws:ses:${AWS::Region}:${AWS::AccountId}:template/AppointmentConfirmation-${self:custom.stage}"
    Export:
      Name: ${self:service}-${self:custom.stage}-confirmation-template

  AppointmentReminderTemplateArn:
    Description: "Appointment Reminder Template ARN"
    Value: !Sub "arn:aws:ses:${AWS::Region}:${AWS::AccountId}:template/AppointmentReminder-${self:custom.stage}"
    Export:
      Name: ${self:service}-${self:custom.stage}-reminder-template
